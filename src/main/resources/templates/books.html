<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Каталог книг</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        .ai-search-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .search-explanation {
            background-color: #f8f9fa;
            border-left: 3px solid #667eea;
            padding: 8px 12px;
            margin-top: 8px;
            font-size: 0.85rem;
        }
        .search-mode-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .mode-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }
        .mode-btn:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }
        .mode-btn.active {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .mode-btn i {
            font-size: 1.5rem;
            display: block;
            margin-bottom: 5px;
        }
    </style>
</head>
<body class="p-4 bg-light">
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="bi bi-book"></i> Каталог книг</h1>
        <div>
            <a th:href="@{/cart}" class="btn btn-outline-success me-2">
                <i class="bi bi-cart"></i> Корзина
            </a>
            <span sec:authorize="isAuthenticated()" class="me-3">
                Здравствуйте, <strong sec:authentication="name">User</strong>!
            </span>
            <a sec:authorize="hasRole('ADMIN')" th:href="@{/admin}" class="btn btn-outline-danger me-2">
                <i class="bi bi-shield-lock"></i> Админ
            </a>
            <a sec:authorize="!isAuthenticated()" th:href="@{/login}" class="btn btn-outline-primary me-2">Войти</a>
            <a sec:authorize="!isAuthenticated()" th:href="@{/register}" class="btn btn-primary me-2">Регистрация</a>
            <a sec:authorize="isAuthenticated()" th:href="@{/orders}" class="btn btn-outline-secondary me-2">
                <i class="bi bi-box"></i> Мои заказы
            </a>
            <form sec:authorize="isAuthenticated()" th:action="@{/logout}" method="post" class="d-inline">
                <button type="submit" class="btn btn-outline-secondary">
                    <i class="bi bi-box-arrow-right"></i> Выйти
                </button>
            </form>
        </div>
    </div>

    <!-- Переключатель режима поиска -->
    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            <div class="search-mode-toggle">
                <div class="mode-btn" id="standardMode" onclick="setSearchMode('standard')">
                    <i class="bi bi-search"></i>
                    <strong>Обычный поиск</strong>
                    <small class="d-block text-muted">По названию книги</small>
                </div>
                <div class="mode-btn" id="aiMode" onclick="setSearchMode('ai')">
                    <i class="bi bi-stars"></i>
                    <strong>Умный поиск</strong>
                    <small class="d-block text-muted">На естественном языке</small>
                </div>
            </div>

            <form id="searchForm" method="get" th:action="@{/books}">
                <input type="hidden" name="mode" id="searchMode" value="standard">
                <div class="input-group input-group-lg">
                    <input type="text"
                           name="q"
                           id="searchInput"
                           class="form-control"
                           th:value="${searchQuery}"
                           placeholder="Введите запрос..."/>
                    <button class="btn btn-primary" type="submit" style="min-width: 120px;">
                        <i class="bi bi-search"></i> <span id="searchBtnText">Поиск</span>
                    </button>
                    <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>

                <!-- Примеры запросов для AI-поиска -->
                <div id="aiExamples" style="display: none;" class="mt-2">
                    <small class="text-muted">
                        <i class="bi bi-lightbulb"></i> Примеры:
                        <a href="#" onclick="setExample('книга про магию для подростков')">книга про магию для подростков</a> •
                        <a href="#" onclick="setExample('детектив в духе Агаты Кристи')">детектив в духе Агаты Кристи</a> •
                        <a href="#" onclick="setExample('что-то веселое и легкое')">что-то веселое и легкое</a>
                    </small>
                </div>
            </form>
        </div>
    </div>

    <!-- Результаты поиска -->
    <div th:if="${searchQuery != null}" class="alert alert-info mb-4">
        <div class="d-flex align-items-center">
            <i class="bi bi-info-circle me-2"></i>
            <div>
                <strong>
                    <span th:if="${searchMode == 'ai'}">
                        <span class="badge ai-search-badge me-2"><i class="bi bi-robot"></i> AI-поиск</span>
                    </span>
                    Результаты поиска для: "<span th:text="${searchQuery}"></span>"
                </strong>
                <div th:if="${resultCount != null}" class="mt-1">
                    Найдено книг: <strong th:text="${resultCount}">0</strong>
                </div>
            </div>
        </div>
    </div>

    <!-- Каталог книг -->
    <div class="row">
        <div class="col-md-3 mb-4" th:each="book : ${books}">
            <div class="card h-100 shadow-sm">
                <div th:if="${book.imagePath}" style="height: 300px; overflow: hidden; background-color: #f8f9fa;">
                    <img th:src="${book.imagePath}"
                         class="card-img-top"
                         th:alt="${book.title}"
                         style="width: 100%; height: 100%; object-fit: cover;">
                </div>
                <div th:unless="${book.imagePath}"
                     class="bg-secondary text-white d-flex align-items-center justify-content-center"
                     style="height: 300px; font-size: 3rem;">
                    <i class="bi bi-book"></i>
                </div>

                <div class="card-body d-flex flex-column">
                    <h5 class="card-title" th:text="${book.title}">Title</h5>
                    <p class="card-text text-muted small" th:text="${book.author}">Author</p>
                    <div class="mb-2">
                        <span class="badge bg-secondary small" th:text="${book.genre}">Genre</span>
                    </div>

                    <!-- Объяснение AI-поиска -->
                    <div th:if="${explanations != null and explanations.containsKey(book.id)}"
                         class="search-explanation">
                        <i class="bi bi-lightbulb-fill text-warning"></i>
                        <strong>Почему подходит:</strong>
                        <div th:text="${explanations.get(book.id)}" class="mt-1"></div>
                    </div>

                    <p class="card-text mt-auto">
                        <strong class="text-primary" th:text="${#numbers.formatDecimal(book.price, 1, 2)} + ' ₽'">0.00 ₽</strong>
                    </p>
                    <div class="mt-2">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <small class="text-success" th:if="${book.stock > 0}">
                                <i class="bi bi-check-circle"></i> В наличии: <span th:text="${book.stock}">0</span>
                            </small>
                            <small class="text-danger" th:if="${book.stock == 0}">
                                <i class="bi bi-x-circle"></i> Нет в наличии
                            </small>
                        </div>
                        <a th:href="@{'/books/' + ${book.id}}" class="btn btn-outline-primary w-100">
                            <i class="bi bi-eye"></i> Подробнее
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div th:if="${books.empty}" class="text-center py-5 text-muted">
        <i class="bi bi-inbox" style="font-size: 4rem;"></i>
        <h3 class="mt-3">Книги не найдены</h3>
        <p>Попробуйте изменить параметры поиска или используйте умный поиск</p>
        <button class="btn btn-primary" onclick="clearSearch()">Показать все книги</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Текущий режим поиска
    let currentMode = 'standard';

    // Инициализация при загрузке страницы
    document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const mode = urlParams.get('mode') || 'standard';
        setSearchMode(mode);
    });

    // Переключение режима поиска
    function setSearchMode(mode) {
        currentMode = mode;
        document.getElementById('searchMode').value = mode;

        // Обновляем визуальное состояние кнопок
        document.getElementById('standardMode').classList.toggle('active', mode === 'standard');
        document.getElementById('aiMode').classList.toggle('active', mode === 'ai');

        // Обновляем placeholder и текст кнопки
        const input = document.getElementById('searchInput');
        const btnText = document.getElementById('searchBtnText');
        const examples = document.getElementById('aiExamples');

        if (mode === 'ai') {
            input.placeholder = 'Опишите, что ищете: "книга про магию для подростков"...';
            btnText.innerHTML = '<i class="bi bi-stars"></i> Найти';
            examples.style.display = 'block';
        } else {
            input.placeholder = 'Введите название книги...';
            btnText.innerHTML = '<i class="bi bi-search"></i> Найти';
            examples.style.display = 'none';
        }
    }

    // Установка примера запроса
    function setExample(text) {
        event.preventDefault();
        document.getElementById('searchInput').value = text;
        setSearchMode('ai');
    }

    // Очистка поиска
    function clearSearch() {
        window.location.href = '/books';
    }
</script>
</body>
</html>